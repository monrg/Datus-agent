name: unit test
on:
  workflow_dispatch:
    inputs:
      force-rebuild-kb:
        description: 'Force rebuild knowledge base data'
        type: boolean
        default: false
  workflow_call:
    inputs:
      force-rebuild-kb:
        type: boolean
        default: false
    outputs:
      build-artifact:
        description: "Built artifact path"
        value: ${{ jobs.build.outputs.build-artifact }}

jobs:
  run-ut:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt
          pip install --upgrade --no-cache-dir datus-semantic-metricflow

      - name: Setup config file
        run: |
          cp /home/datus_ci/ci_template/agent.yml conf/agent.yml
          cp /home/datus_ci/ci_template/ci.env .env

      - name: Load environment variables
        run: |
          echo "Loading environment variables from .env file..."
          # Export all variables from .env to GITHUB_ENV so they persist across steps
          while IFS= read -r line || [ -n "$line" ]; do
            # Skip empty lines and comments
            if [[ ! -z "$line" && ! "$line" =~ ^[[:space:]]*# ]]; then
              # Remove any surrounding whitespace and export to GITHUB_ENV
              var_name=$(echo "$line" | cut -d'=' -f1)
              echo "Loading variable: $var_name"
              echo "$line" >> $GITHUB_ENV
            fi
          done < .env
          echo "Environment variables loaded successfully"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Cache knowledge base data
        id: kb-cache
        uses: actions/cache@v4
        with:
          path: |
            tests/data/datus_db_bird_school
            tests/data/datus_db_bird_sqlite
            tests/data/datus_db_ssb_sqlite
          key: ${{ runner.os }}-kb-${{ hashFiles('build_scripts/build_test_data.sh', 'sample_data/**', 'datus/storage/**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-kb-

      - name: Build test data
        if: steps.kb-cache.outputs.cache-hit != 'true' || inputs.force-rebuild-kb == true
        run: |
          echo "Building test data before running pytest..."
          chmod +x build_scripts/build_test_data.sh
          ./build_scripts/build_test_data.sh || exit 1
          echo "Test data build completed"

      - name: run acceptance tests
        run: |
          python -m pytest -m acceptance tests/

      - name: run regression tests (single model)
        run: |
          python -m pytest -m regression --single-model tests/regression/test_regression_llm.py
